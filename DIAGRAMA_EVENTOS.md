# ?? Diagrama Visual: Fluxo de Eventos

## ?? Compara??o: Antes vs. Depois

### ? SISTEMA ANTIGO (Client-Side)

```
?? USU?RIO
 ?
 ? Clica em "Comprar Agora"
 ?
??????????????????????????????????????
?  BROWSER (Client-Side)             ?
?                                    ?
?  ? Meta Pixel JS carrega           ?
?  ? 7 arquivos de tracking          ?
?  ? Duplica??o de eventos           ?
?  ? Dados PII expostos              ?
?                                    ?
??????????????????????????????????????
              ?
              ? 60-70% dos eventos
              ? (40% bloqueados por ad-blockers)
              ?
         ???????????
         ?   ??    ?  ? Ad-Blocker bloqueia
         ? BLOQUEIO?
         ???????????
              ?
              ? S? 60-70% passa
              ?
       ???????????????
       ? META SERVERS?
       ?  EQM: 7.5   ?
       ???????????????
```

### ? SISTEMA NOVO (Server-Side via Stape.io)

```
?? USU?RIO
 ?
 ? Clica em "Comprar Agora"
 ?
??????????????????????????????????????
?  BROWSER (Frontend)                ?
?                                    ?
?  trackCTAClick('Comprar Agora')    ?
?  ? 1 fun??o simples                ?
?  ? Sem Meta Pixel JS               ?
?  ? C?digo limpo                    ?
?                                    ?
??????????????????????????????????????
              ?
              ? fetch('/api/track')
              ? 100% dos eventos (n?o bloque?vel)
              ?
??????????????????????????????????????
?  SEU SERVIDOR (Next.js API)        ?
?  /src/app/api/track/route.ts       ?
?                                    ?
?  1. Hash SHA-256 de PII            ?
?     user@example.com               ?
?     ? 4d186321c1a7f0f354...        ?
?                                    ?
?  2. Captura IP real                ?
?     ? N?o ? VPN/Proxy              ?
?     ? IP do seu servidor           ?
?                                    ?
?  3. Captura User-Agent             ?
?     ? Browser real                 ?
?     ? Device info                  ?
?                                    ?
?  4. Gera Event ID ?nico            ?
?     Lead_1709834521_a3x9k2         ?
?                                    ?
??????????????????????????????????????
              ?
              ? POST com dados hasheados
              ? 100% dos eventos
              ?
??????????????????????????????????????
?  STAPE.IO GATEWAY                  ?
?  (Server-Side Tracking)            ?
?                                    ?
?  1. Valida formato                 ?
?  2. Enriquece dados                ?
?  3. Deduplica (event_id)           ?
?  4. Aplica regras de neg?cio       ?
?  5. Rate limiting                  ?
?                                    ?
??????????????????????????????????????
              ?
              ? Meta Conversions API (CAPI)
              ? 100% dos eventos chegam
              ?
       ???????????????
       ? META SERVERS?
       ?  EQM: 9.0+  ?
       ???????????????
```

---

## ?? Fluxo Detalhado: Evento "Lead"

### Timeline Completa

```
TEMPO  ?  A??O                           ?  ONDE
?????????????????????????????????????????????????????????????
       ?                                 ?
0ms    ?  Usu?rio preenche formul?rio    ?  ?? Browser
       ?  ? Nome: Jo?o Silva             ?
       ?  ? Email: joao@email.com        ?
       ?  ? Tel: (11) 99999-9999         ?
       ?                                 ?
?????????????????????????????????????????????????????????????
       ?                                 ?
1ms    ?  Clica em "Enviar"              ?  ?? Browser
       ?                                 ?
?????????????????????????????????????????????????????????????
       ?                                 ?
2ms    ?  handlePreCheckoutSubmit()      ?  ?? Browser
       ?  ? Limpa e formata dados        ?  (page.tsx)
       ?  ? Salva no localStorage        ?
       ?                                 ?
?????????????????????????????????????????????????????????????
       ?                                 ?
5ms    ?  trackLead(userData)            ?  ?? Browser
       ?  {                              ?  (trackingService.ts)
       ?    email: "joao@email.com",     ?
       ?    firstName: "Jo?o",           ?
       ?    lastName: "Silva",           ?
       ?    phone: "11999999999"         ?
       ?  }                              ?
       ?                                 ?
?????????????????????????????????????????????????????????????
       ?                                 ?
10ms   ?  fetch('/api/track')            ?  ?? Browser ? ??? Server
       ?  POST request                   ?
       ?                                 ?
?????????????????????????????????????????????????????????????
       ?                                 ?
50ms   ?  API Route recebe               ?  ??? Server
       ?  /src/app/api/track/route.ts    ?  (Next.js API)
       ?                                 ?
?????????????????????????????????????????????????????????????
       ?                                 ?
51ms   ?  generateEventId()              ?  ??? Server
       ?  ? "Lead_1709834521_a3x9k2"     ?
       ?                                 ?
?????????????????????????????????????????????????????????????
       ?                                 ?
52ms   ?  getClientIP(request)           ?  ??? Server
       ?  ? x-forwarded-for              ?
       ?  ? "187.123.45.67"              ?
       ?                                 ?
?????????????????????????????????????????????????????????????
       ?                                 ?
55ms   ?  hashSHA256(userData)           ?  ??? Server
       ?                                 ?
       ?  "joao@email.com"               ?
       ?  ? hash SHA-256                 ?
       ?  ? "4d186321c1a7f0..."          ?
       ?                                 ?
       ?  "11999999999"                  ?
       ?  ? hash SHA-256                 ?
       ?  ? "d3d5c9a62f96..."            ?
       ?                                 ?
       ?  Todos dados hasheados ?       ?
       ?                                 ?
?????????????????????????????????????????????????????????????
       ?                                 ?
60ms   ?  Monta payload                  ?  ??? Server
       ?  {                              ?
       ?    data: [{                     ?
       ?      event_name: "Lead",        ?
       ?      event_time: 1709834521,    ?
       ?      event_id: "Lead_...",      ?
       ?      user_data: {               ?
       ?        em: "4d186321c1...",     ?
       ?        ph: "d3d5c9a62...",      ?
       ?        fn: "9b871512...",       ?
       ?        ln: "f0e4c2f7...",       ?
       ?        client_ip: "187.123..",  ?
       ?        client_ua: "Mozilla..."  ?
       ?      },                         ?
       ?      custom_data: {             ?
       ?        value: 15.0,             ?
       ?        currency: "BRL"          ?
       ?      }                          ?
       ?    }],                          ?
       ?    access_token: "EAAxx..."     ?
       ?  }                              ?
       ?                                 ?
?????????????????????????????????????????????????????????????
       ?                                 ?
100ms  ?  POST para Stape.io             ?  ??? Server ? ?? Stape
       ?  URL:                           ?
       ?  {STAPE_URL}/v15.0/            ?
       ?  {PIXEL_ID}/events              ?
       ?                                 ?
?????????????????????????????????????????????????????????????
       ?                                 ?
150ms  ?  Stape.io processa              ?  ?? Stape.io
       ?  ? Valida payload               ?
       ?  ? Enriquece dados              ?
       ?  ? Verifica duplicatas          ?
       ?  ? Aplica transforma??es        ?
       ?                                 ?
?????????????????????????????????????????????????????????????
       ?                                 ?
200ms  ?  Stape ? Meta CAPI              ?  ?? Stape ? ?? Meta
       ?  POST para:                     ?
       ?  graph.facebook.com/            ?
       ?  v15.0/{PIXEL_ID}/events        ?
       ?                                 ?
?????????????????????????????????????????????????????????????
       ?                                 ?
300ms  ?  Meta processa                  ?  ?? Meta Servers
       ?  ? Calcula EQM                  ?
       ?  ? Match com usu?rios           ?
       ?  ? Atribui convers?o            ?
       ?  ? Atualiza audi?ncias          ?
       ?  ? Otimiza campanhas            ?
       ?                                 ?
?????????????????????????????????????????????????????????????
       ?                                 ?
350ms  ?  Retorna resposta               ?  ?? Meta ? ?? Stape
       ?  {                              ?
       ?    events_received: 1,          ?
       ?    messages: []                 ?
       ?  }                              ?
       ?                                 ?
?????????????????????????????????????????????????????????????
       ?                                 ?
400ms  ?  Stape retorna                  ?  ?? Stape ? ??? Server
       ?  { success: true }              ?
       ?                                 ?
?????????????????????????????????????????????????????????????
       ?                                 ?
450ms  ?  API retorna                    ?  ??? Server ? ?? Browser
       ?  {                              ?
       ?    success: true,               ?
       ?    eventId: "Lead_..."          ?
       ?  }                              ?
       ?                                 ?
?????????????????????????????????????????????????????????????
       ?                                 ?
500ms  ?  Console.log                    ?  ?? Browser
       ?  "? Lead enviado com sucesso"  ?
       ?                                 ?
?????????????????????????????????????????????????????????????

TOTAL: 500ms (0.5 segundos)
```

---

## ?? Dados Enviados vs. Dados Recebidos

### O que voc? envia no Frontend

```typescript
await trackLead({
  email: 'joao@email.com',
  phone: '11999999999',
  firstName: 'Jo?o',
  lastName: 'Silva',
  city: 'S?o Paulo',
  state: 'SP',
  zip: '01310100',
  country: 'br'
});
```

### O que chega no Meta (ap?s processamento)

```json
{
  "event_name": "Lead",
  "event_time": 1709834521,
  "event_id": "Lead_1709834521_a3x9k2",
  "event_source_url": "https://seu-site.com/",
  "action_source": "website",
  
  "user_data": {
    "em": "4d186321c1a7f0f354b297e8914ab240a7b7c64a7a5a45e07b0ac1e6f02f8d7c",
    "ph": "d3d5c9a62f96fdcb5c8e85e9d2d6c3a84e5f7f8c9d6e5f4a3b2c1d0e9f8a7b6c5",
    "fn": "9b871512327c09ce91dd649b3f96a63b7408ef267c8cc5710114e629730cb61",
    "ln": "f0e4c2f76c58916ec258f246851bea091d14d4247a2fc3e18694461b1816e13b",
    "ct": "e0c2bc3556abf5ff9c7b0c03f4e3e47a3fde2e0b4b3c3f7d5f2f1a8c6d4e2f0a",
    "st": "f3c8d5f2e1b4c3a2d1f0e9d8c7b6a5f4e3d2c1b0a9f8e7d6c5b4a3f2e1d0c9",
    "zp": "b8f4c3e2d1f0a9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5",
    "country": "7e97b8f3e4d2c1a0f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8",
    "client_ip_address": "187.123.45.67",
    "client_user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)..."
  },
  
  "custom_data": {
    "value": 15.0,
    "currency": "BRL",
    "content_name": "Formul?rio de Contato - Sistema 4 Fases",
    "content_category": "lead_generation"
  }
}
```

**?? Seguran?a:** Todos os dados PII foram hasheados com SHA-256 no servidor!

---

## ?? Event Quality Match (EQM) - Visual

```
??????????????????????????????????????????????????
?  META EVENT QUALITY SCORE                      ?
??????????????????????????????????????????????????
?                                                ?
?  ?? Email                    ???????????? 5.0  ?
?  ?? Telefone                 ???????????? 4.0  ?
?  ?? Nome + Sobrenome         ????????     3.0  ?
?  ???  Cidade                  ????????     3.0  ?
?  ???  Estado                  ????????     3.0  ?
?  ?? CEP                      ????????     3.0  ?
?  ?? Pa?s                     ????         2.0  ?
?  ?? IP                       ???????????? 4.0  ?
?  ?? User-Agent               ????         2.0  ?
?                                                ?
??????????????????????????????????????????????????
?  TOTAL:                      ??????????   9.2  ?
??????????????????????????????????????????????????

? N?o enviado
? Enviado parcialmente
? Enviado completo

? VOC? EST? ENVIANDO: 9/9 campos = EQM 9.0-9.5/10
```

---

## ?? Ciclo de Vida Completo de Uma Convers?o

```
DIA 0 (Descoberta)
==================
?? Usu?rio v? an?ncio no Facebook
   ?
   Clica no an?ncio
   ?
?? PageView
   ? Meta registra: "Usu?rio visitou site"
   ? Pixel marca??o (FBC cookie)
   ?
?? ViewContent (15s ou 25% scroll)
   ? Meta registra: "Usu?rio interessado"
   ? Come?a a rastrear comportamento


DIA 0 (Engajamento)
===================
?? ScrollDepth 50%
   ? Meta registra: "Usu?rio engajado"
   ?
??? CTAClick "Quero Economizar"
   ? Meta registra: "Inten??o de compra"
   ?
?? ScrollDepth 75%
   ? Meta registra: "Alto engajamento"


DIA 0 (Convers?o)
=================
?? Lead (formul?rio preenchido)
   ? Meta registra: "Lead qualificado"
   ? Dados completos (EQM 9.0+)
   ? Cria audi?ncia "Leads"
   ?
?? InitiateCheckout
   ? Meta registra: "Inten??o forte"
   ? Atualiza probabilidade de compra
   ? Otimiza lances em tempo real


DIA 0-2 (Confirma??o)
=====================
?? Purchase (webhook checkout)
   ? Meta registra: "CONVERS?O CONFIRMADA"
   ? Atribui convers?o ao an?ncio correto
   ? Calcula ROI
   ? Atualiza audi?ncias:
     - ? "Compradores"
     - ? "Clientes de alto valor"
   ? Otimiza campanhas:
     - ?? Aumenta or?amento em ads similares
     - ?? Diminui em ads com baixa convers?o


DIA 3-30 (Otimiza??o)
=====================
?? Meta AI aprende padr?es
   ? "Usu?rios que fazem X convertem melhor"
   ? "Hor?rio Y tem mais convers?es"
   ? "Dispositivo Z converte mais"
   ?
?? Campanhas otimizadas automaticamente
   ? Targeting ajustado
   ? Lances otimizados
   ? Budget redistribu?do
   ? Criativos priorizados


DIA 30+ (Retargeting)
=====================
?? Remarketing inteligente
   ? Upsell para quem comprou
   ? Remarketing para quem n?o comprou
   ? Audi?ncias lookalike
   ? Cross-sell baseado em comportamento
```

---

## ?? Resumo Visual: Antes vs. Depois

```
?????????????????????????????????????????????????????????????
?                    ANTES (Client-Side)                    ?
?????????????????????????????????????????????????????????????
?                                                           ?
?  ?? 19 arquivos de tracking                               ?
?  ?? 5.000 linhas de c?digo                                ?
?  ?? 7 sistemas duplicados                                 ?
?  ?? ~140KB de c?digo                                      ?
?  ??  40% dos eventos bloqueados                           ?
?  ??  EQM 7.5-8.5/10                                       ?
?  ??  Dados PII expostos no browser                        ?
?  ??  IP pode ser VPN/Proxy                                ?
?                                                           ?
?????????????????????????????????????????????????????????????

                          ? MIGRA??O ?

?????????????????????????????????????????????????????????????
?                   DEPOIS (Server-Side)                    ?
?????????????????????????????????????????????????????????????
?                                                           ?
?  ? 2 arquivos de tracking                                ?
?  ? 320 linhas de c?digo                                  ?
?  ? 1 sistema unificado                                   ?
?  ? ~15KB de c?digo                                       ?
?  ? 100% dos eventos capturados                           ?
?  ? EQM 9.0-9.5/10                                        ?
?  ? Dados PII hasheados no servidor                       ?
?  ? IP real capturado no backend                          ?
?                                                           ?
?????????????????????????????????????????????????????????????
```

---

## ?? Pr?ximos Passos

1. **Leia:** `QUICK_START.md` para configurar em 5 minutos
2. **Teste:** Use `curl` para testar a API
3. **Monitore:** Stape.io Preview Mode + Meta Events Manager
4. **Implemente:** Purchase event quando tiver confirma??o do checkout

**Boa sorte com seu tracking server-side! ??**
